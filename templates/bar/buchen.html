{% extends "base.html" %}
{% block content %}
<div class="container-fluid mt-4">

  <!-- Überschrift + Zurück-Button -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0 text-center flex-grow-1">
      {{ mitglied.name }}{% if mitglied.nickname %} ({{ mitglied.nickname }}){% endif %}:
      <span id="guthaben" class="fw-bold">{{ "%.2f"|format(mitglied.guthaben) }} €</span>
    </h3>
    <a href="{{ url_for('bar.bar_interface') }}" class="btn btn-secondary ms-3">
      &larr; Zurück
    </a>
  </div>

  <div class="row">
    <!-- Linke Seite: Produkte -->
    <div class="col-md-8">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5>Produkte</h5>
      </div>

      <div class="row g-3">
        {% for artikel in artikel_liste %}
        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
          <button
            class="btn btn-primary w-100 artikel-btn d-flex flex-column justify-content-center align-items-center text-center"
            style="min-height: 180px; font-size: 1.3rem; padding: 1rem; white-space: normal;"
            data-artikel-id="{{ artikel.id }}"
            data-artikel-name="{{ artikel.name }}"
            data-artikel-preis="{{ artikel.preis }}"
          >
            {{ artikel.name }}<br>
            <small>{{ "%.2f"|format(artikel.preis) }} €</small>
          </button>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Rechte Seite: Übersicht -->
    <div class="col-md-4 mt-4 mt-md-0">
      <h5>Letzte Buchungen</h5>
      <ul class="list-group mb-3">
        {% for b in buchungen %}
        <li class="list-group-item d-flex justify-content-between">
          <span>{{ b.menge }} × {{ b.artikel_obj.name }}</span>
          <span>{{ "%.2f"|format(b.gesamtpreis) }} €</span>
        </li>
        {% else %}
        <li class="list-group-item text-muted">Keine Buchungen vorhanden.</li>
        {% endfor %}
      </ul>

      <h5>Aktuelle Bestellung</h5>
      <ul id="bestellung-list" class="list-group mb-3"></ul>
      <button id="buchen-btn" class="btn btn-success w-100">Buchen</button>
    </div>
  </div>
</div>

<script>
const mitgliedId = {{ mitglied.id }};
const bestellung = [];

// Produkte klicken → zur aktuellen Bestellung hinzufügen
document.querySelectorAll(".artikel-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const artikelId = btn.dataset.artikelId;
    const name = btn.dataset.artikelName;
    const preis = parseFloat(btn.dataset.artikelPreis);
    const menge = 1

    const bestehend = bestellung.find(b => b.artikelId === artikelId);
    if (bestehend) bestehend.menge += menge;
    else bestellung.push({ artikelId, name, preis, menge });

    renderBestellung();
  });
});



function renderBestellung() {
  const list = document.getElementById("bestellung-list");
  list.innerHTML = "";
  let summe = 0;

  bestellung.forEach(item => {
    const gesamt = item.preis * item.menge;
    summe += gesamt;

    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";

    // --- Linke Seite: Menge + Name ---
    const leftDiv = document.createElement("div");
    leftDiv.className = "d-flex align-items-center flex-grow-1";
    leftDiv.style.minWidth = "0"; // Wichtig für ellipsis!

    // Helper für runde Buttons
    const createRoundButton = (text, colorClass, onClick) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = `btn ${colorClass} btn-sm rounded-circle d-flex align-items-center justify-content-center`;
      btn.style.width = "32px";
      btn.style.height = "32px";
      btn.style.minWidth = "32px";
      btn.style.minHeight = "32px";
      btn.style.flexShrink = "0"; // Nie verkleinern
      btn.textContent = text;
      btn.addEventListener("click", onClick);
      return btn;
    };

    // Minus-Button (rot)
    const minusBtn = createRoundButton("−", "btn-danger", () => {
      if (item.menge > 1) {
        item.menge--;
      } else {
        bestellung = bestellung.filter(b => b.artikelId !== item.artikelId);
      }
      renderBestellung();
    });
    leftDiv.appendChild(minusBtn);

    // Mengen-Eingabe
    const qtyInput = document.createElement("input");
    qtyInput.type = "number";
    qtyInput.min = 1;
    qtyInput.value = item.menge;
    qtyInput.className = "form-control form-control-sm text-center mx-2";
    qtyInput.style.width = "50px";
    qtyInput.style.padding = "0";
    qtyInput.style.margin = "0";
    qtyInput.style.height = "32px";
    qtyInput.style.lineHeight = "32px";
    qtyInput.style.textAlign = "center";
    qtyInput.style.flexShrink = "0"; // auch fix
    qtyInput.addEventListener("change", () => {
      const neueMenge = parseInt(qtyInput.value);
      if (isNaN(neueMenge) || neueMenge < 1) return;
      item.menge = neueMenge;
      renderBestellung();
    });
    leftDiv.appendChild(qtyInput);

    // Plus-Button (grün)
    const plusBtn = createRoundButton("+", "btn-success", () => {
      item.menge++;
      renderBestellung();
    });
    leftDiv.appendChild(plusBtn);

    // Artikelname
    const nameSpan = document.createElement("span");
    nameSpan.className = "ms-3 flex-grow-1 text-truncate";
    nameSpan.textContent = item.name;
    nameSpan.style.overflow = "hidden";
    nameSpan.style.whiteSpace = "nowrap";
    nameSpan.style.textOverflow = "ellipsis";
    nameSpan.style.minWidth = "0"; // zwingend nötig für ellipsis
    leftDiv.appendChild(nameSpan);

    li.appendChild(leftDiv);

    // --- Rechte Seite: Preis + Entfernen ---
    const rightDiv = document.createElement("div");
    rightDiv.className = "d-flex align-items-center";
    rightDiv.style.flexShrink = "0"; // niemals verkleinern

    const preisSpan = document.createElement("span");
    preisSpan.className = "me-3";
    preisSpan.innerHTML = `${gesamt.toFixed(2)} €`;
    preisSpan.style.flexShrink = "0";
    rightDiv.appendChild(preisSpan);

    const removeBtn = document.createElement("button");
    removeBtn.className = "btn btn-danger btn-sm d-flex align-items-center justify-content-center";
    removeBtn.style.flexShrink = "0";
    removeBtn.innerHTML = "×";
    removeBtn.addEventListener("click", () => {
      bestellung = bestellung.filter(b => b.artikelId !== item.artikelId);
      renderBestellung();
    });
    rightDiv.appendChild(removeBtn);

    li.appendChild(rightDiv);
    list.appendChild(li);
  });

  // Gesamt-Summe unten
  if (bestellung.length > 0) {
    const sumLi = document.createElement("li");
    sumLi.className = "list-group-item d-flex justify-content-between fw-bold";
    sumLi.innerHTML = `<span>Gesamt:</span><span>${summe.toFixed(2)} €</span>`;
    list.appendChild(sumLi);
  }
}

// Buchung absenden (Flashes + Redirect)
document.getElementById("buchen-btn").addEventListener("click", async () => {
  if (bestellung.length === 0) return;

  try {
    for (const item of bestellung) {
      const res = await fetch("/bar/buchen", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          mitglied_id: mitgliedId,
          artikel_id: item.artikelId,
          menge: item.menge
        })
      });

      const data = await res.json();
      if (!data.success) {
        window.location.href = "{{ url_for('bar.bar_interface') }}";
        return;
      }
    }

    // Alles erfolgreich → zurück zur Suche, Flash wird angezeigt
    window.location.href = "{{ url_for('bar.bar_interface') }}";

  } catch (err) {
    console.error("Buchung fehlgeschlagen", err);
    window.location.href = "{{ url_for('bar.bar_interface') }}";
  }
});
</script>
{% endblock %}
