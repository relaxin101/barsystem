{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4 text-center">Bar-Interface</h2>

  <!-- Suchfeld -->
  <div class="input-group mb-4">
    <input
      id="member-search"
      type="text"
      class="form-control form-control-lg"
      placeholder="ðŸ” Mitglied suchen..."
      aria-label="Mitglied suchen"
    />
  </div>

  <!-- Grid -->
  <div id="member-grid" class="row g-3 justify-content-center">
    <!-- Wird per JS befÃ¼llt -->
  </div>
</div>

<style>
  .member-card {
    border-radius: 0.8rem;
    padding: 0.8rem; /* ðŸ‘ˆ kompakter */
    text-align: center;
    color: #fff;
    transition: transform 0.15s ease-in-out, box-shadow 0.15s;
    cursor: default;
    min-height: 110px; /* ðŸ‘ˆ etwas flacher */
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .member-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
  }

  .member-name-row {
    display: flex;
    justify-content: center;
    align-items: baseline;
    gap: 0.3rem;
    font-weight: 600;
    font-size: 1rem; /* ðŸ‘ˆ etwas kleiner */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .member-name {
    max-width: 65%; /* ðŸ‘ˆ mehr Platz fÃ¼r Name */
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .member-nickname {
    opacity: 0.9;
    font-size: 0.9rem;
  }

  .member-balance {
    font-size: 0.95rem;
    font-weight: 600;
    margin-top: 0.3rem;
  }

  .color-1 { background: #007bff; }
  .color-2 { background: #28a745; }
  .color-3 { background: #17a2b8; }
  .color-4 { background: #ffc107; color: #212529; }
  .color-5 { background: #fd7e14; }
  .color-6 { background: #6f42c1; }
</style>

<script>
  // ---------- Mitglieder laden ----------
  async function fetchMembers(search = "") {
    try {
      const url = search
        ? `/api/members?search=${encodeURIComponent(search)}`
        : "/api/members";
      const res = await fetch(url);
      const data = await res.json();

      if (data.success) renderMembers(data.members);
      else renderError("Fehler beim Laden der Mitglieder.");
    } catch (err) {
      renderError("Netzwerkfehler beim Laden der Mitglieder.");
      console.error(err);
    }
  }

  // ---------- Mitglieder anzeigen ----------
  function renderMembers(members) {
    const grid = document.getElementById("member-grid");
    grid.innerHTML = "";

    if (members.length === 0) {
      grid.innerHTML =
        '<div class="col-12 text-center text-muted">Keine Mitglieder gefunden.</div>';
      return;
    }

    members.forEach((m, i) => {
      const colorClass = `color-${(i % 6) + 1}`;
      const card = document.createElement("div");
      card.className = "col-6 col-md-4 col-lg-3";
      const nickname = m.nickname ? `(${m.nickname})` : "";
      card.innerHTML = `
        <div class="member-card ${colorClass}" title="${m.name}">
          <div class="member-name-row">
            <span class="member-name">${m.name}</span>
            <span class="member-nickname">${nickname}</span>
          </div>
          <div class="member-balance">${m.guthaben.toFixed(2)} â‚¬</div>
        </div>`;
      grid.appendChild(card);
    });
  }

  function renderError(msg) {
    const grid = document.getElementById("member-grid");
    grid.innerHTML = `<div class="col-12 text-center text-danger">${msg}</div>`;
  }

  // ---------- Live-Suche (mit Delay & MindestlÃ¤nge) ----------
  let searchTimeout = null;
  const searchInput = document.getElementById("member-search");

  searchInput.addEventListener("input", (e) => {
    clearTimeout(searchTimeout);
    const search = e.target.value.trim();

    searchTimeout = setTimeout(() => {
      if (search.length >= 2 || search.length === 0) {
        fetchMembers(search);
      }
    }, 500);
  });

  // ---------- Initiale Hotlist ----------
  document.addEventListener("DOMContentLoaded", () => {
    fetchMembers("");
  });
</script>
{% endblock %}
