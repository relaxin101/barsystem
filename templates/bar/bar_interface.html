{% extends "base.html" %}
{% block content %}
<div class="container-fluid mt-4 d-flex flex-column" style="height: calc(100vh - 100px);">
  <h3 class="mb-3 text-center flex-shrink-0">Mitglieder suchen oder auswählen</h3>

  <input
    type="text"
    id="search"
    class="form-control mb-3 flex-shrink-0"
    placeholder="Mitglied oder Spitzname eingeben..."
  />

  <!-- Scrollbarer Grid-Bereich -->
  <div id="members-grid" class="row g-3 overflow-auto"></div>
</div>

<script>
let searchTimeout = null;

const colors = [
  "#1b932c", "#0f4c75", "#3282b8", "#1a759f",
  "#6a2c70", "#b83b5e", "#f08a5d", "#f28482"
];

async function loadMembers(search = "") {
  const res = await fetch(`/api/members?search=${encodeURIComponent(search)}`);
  const data = await res.json();
  if (!data.success) return;

  const container = document.getElementById("members-grid");
  container.innerHTML = "";

  data.members.forEach(member => {
    const col = document.createElement("div");
    col.className = "col-6 col-md-3 col-lg-2 d-flex";

    const div = document.createElement("div");
    div.className = "text-white rounded member-card d-flex flex-column justify-content-center align-items-center text-center";
    div.style.cursor = "pointer";
    div.style.fontSize = "1.3rem";
    div.style.padding = "0.5rem";

    const colorIndex = member.id % colors.length;
    div.style.backgroundColor = colors[colorIndex];
     if (member.blacklist) {
    	div.style.backgroundColor = '#000000';
     }

    let displayName = member.name;
    if (displayName.length > 12) displayName = displayName.slice(0, 12) + "…";

    div.innerHTML = `
      <strong>${displayName}</strong> <small>${member.nickname?.split(",")[0] || ""}</small>
      <div class="text-white-50 mt-1" style="font-size:0.9rem;">${member.guthaben.toFixed(2)} €</div>
    `;

    div.addEventListener("click", () => {
      window.location.href = `/bar/buchen?mitglied_id=${member.id}`;
    });

    col.appendChild(div);
    container.appendChild(col);
  });
}

document.getElementById("search").addEventListener("input", e => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => loadMembers(e.target.value), 400);
});

loadMembers();
</script>

<style>
.member-card {
  width: 100%;
  min-height: 140px;
  max-height: 200px
}
</style>
{% endblock %}
