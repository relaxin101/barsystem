{% extends "base.html" %}

{% block title %}Vereinsbar - Adminbereich{% endblock %} {# Passenden Titel gesetzt #}

{% block head_content %}
{# Spezifisches Styling für den Admin-Bereich #}
<style>
    .bestand-niedrig {
        background-color: #f8d7da; /* Helles Rot für niedrigen Bestand */
        color: #721c24; /* Dunklerer Text */
        font-weight: bold;
    }
    /* Styles für Tabellenverwaltung */
    .table-responsive {
        overflow-x: auto;
        margin-bottom: 20px;
    }
    .table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .table th, .table td {
        padding: 0.75rem;
        vertical-align: top;
        border-top: 1px solid #dee2e6;
        text-align: left;
    }
    .table thead th {
        vertical-align: bottom;
        border-bottom: 2px solid #dee2e6;
        background-color: #f8f9fa;
        color: #495057;
    }
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0,0,0,0.05);
    }
    .table-hover tbody tr:hover {
        background-color: rgba(0,0,0,0.075);
    }
    .button.small, .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        line-height: 1.5;
        border-radius: 0.2rem;
        text-decoration: none;
        display: inline-block;
        margin-right: 5px;
    }
    .btn-primary { background-color: #007bff; color: white; border: 1px solid #007bff; }
    .btn-primary:hover { background-color: #0056b3; border-color: #0056b3; }
    .btn-danger { background-color: #dc3545; color: white; border: 1px solid #dc3545; }
    .btn-danger:hover { background-color: #c82333; border-color: #bd2130; }
    .btn-info { background-color: #17a2b8; color: white; border: 1px solid #17a2b8; }
    .btn-info:hover { background-color: #138496; border-color: #117a8b; }

    .form-control-sm {
        height: calc(1.5em + 0.5rem + 2px);
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        line-height: 1.5;
        border-radius: 0.2rem;
    }
    .d-inline-flex {
        display: inline-flex !important;
    }
    .align-items-center {
        align-items: center !important;
    }
    .mr-2 {
        margin-right: 0.5rem !important;
    }
    .alert {
        padding: 1rem 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid transparent;
        border-radius: 0.25rem;
        margin-top: 15px;
    }
    .alert-warning {
        color: #856404;
        background-color: #fff3cd;
        border-color: #ffeeba;
    }
    .alert-info {
        color: #0c5460;
        background-color: #d1ecf1;
        border-color: #bee5eb;
    }

    /* Styles für Guthaben aufladen Mitgliederauswahl */
    .member-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    .member-item {
        background-color: #e0f2f7; /* Helles Blau für Mitglieder */
        border: 1px solid #b3e5fc;
        border-radius: 5px;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        transition: background-color 0.2s;
        font-weight: bold;
    }
    .member-item:hover {
        background-color: #b3e5fc;
    }
    .member-item h3 {
        margin-top: 0;
        font-size: 1.1em;
    }
    .member-item p {
        margin-bottom: 0;
        font-size: 0.9em;
        color: #555;
    }

    /* Modal-Styling (für Guthaben aufladen) - Wiederholung für Konsistenz */
    .modal {
        display: none; /* Versteckt das Modal standardmäßig */
        position: fixed; /* Über dem gesamten Bildschirm */
        z-index: 1000; /* Ganz oben */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto; /* Scrollbar, falls Inhalt zu groß */
        background-color: rgba(0,0,0,0.6); /* Halbdurchsichtiger Hintergrund */
        backdrop-filter: blur(5px); /* Optional: Unscharfer Hintergrund */
        -webkit-backdrop-filter: blur(5px); /* Für Safari */
        justify-content: center; /* Horizontal zentrieren */
        align-items: center; /* Vertikal zentrieren */
    }

/* Füge eine Klasse für das sichtbare Modal hinzu */
.modal.is-visible {
    display: flex; /* Nur wenn diese Klasse hinzugefügt wird, wird es sichtbar */
    }

    .modal-content {
        background-color: #fefefe;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        width: 90%;
        max-width: 400px;
        text-align: center;
        position: relative; /* Für den Schließen-Button */
    }

    .close-button {
        color: #aaa;
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    .close-button:hover,
    .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    .modal-content label {
        display: block;
        margin-bottom: 15px;
        font-size: 1.1em;
        color: #333;
    }

    .modal-content input[type="number"] {
        width: calc(100% - 20px);
        padding: 10px;
        margin-bottom: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1.2em;
        text-align: center;
    }

    .modal-content button {
        background-color: #007bff;
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
        width: 100%;
    }
    .modal-content button:hover {
        background-color: #0056b3;
    }
</style>
{% endblock %}

{% block content %}
<h1>Admin-Bereich</h1>

{# -- BESTANDS-WARNUNGEN (Nur einmal anzeigen) -- #}
{% if warnungen %}
    <div class="alert alert-warning" role="alert"> {# Diese CSS-Klasse setzt voraus, dass du Bootstrap oder ähnliches hast #}
        <h4>Bestandswarnungen:</h4>
        <ul>
            {% for warnung in warnungen %}
                <li>{{ warnung }}</li>
            {% endfor %}
        </ul>
    </div>
{% endif %}

{# -- ADMIN OPTIONEN -- #}
<div class="admin-section">
    <h2>Admin-Optionen</h2>
    <ul>
        <li><a href="{{ url_for('admin.add_mitglied') }}">Mitglied hinzufügen</a></li>
        <li><a href="{{ url_for('admin.add_artikel') }}">Artikel hinzufügen</a></li>
        <li><a href="{{ url_for('admin.aufladen_seite_anzeigen') }}">Guthaben aufladen</a></li>
        <li><a href="{{ url_for('admin.berichte') }}">Berichte anzeigen</a></li>
        <li><a href="{{ url_for('admin.change_password') }}">Passwort ändern</a></li>
        <li><a href="{{ url_for('admin.top_verkaeufer') }}">Top Verkäufer anzeigen</a></li>
    </ul>
</div>

---

{# -- MITGLIED HINZUFÜGEN -- #}
<h2>Mitglied hinzufügen</h2>
<form action="{{ url_for('admin.add_mitglied') }}" method="POST">
    <label for="name">Name:</label>
    <input type="text" id="name" name="name" required><br><br>
    <label for="pin">PIN:</label>
    <input type="text" id="pin" name="pin" required><br><br>
    <button type="submit">Mitglied hinzufügen</button>
</form>

---

{# -- ARTIKEL HINZUFÜGEN -- #}
<h2>Artikel hinzufügen</h2>
<form action="{{ url_for('admin.add_artikel') }}" method="POST">
    <label for="artikel_name">Name:</label>
    <input type="text" id="artikel_name" name="name" required><br><br>
    <label for="artikel_preis">Preis (€):</label>
    <input type="number" step="0.01" id="artikel_preis" name="preis" required><br><br>
    <label for="artikel_bestand">Bestand:</label> {# Ergänzt: Bestandseingabe beim Hinzufügen #}
    <input type="number" id="artikel_bestand" name="bestand" min="0" value="0" required><br><br>
    <label for="artikel_mindestbestand">Mindestbestand:</label> {# Ergänzt: Mindestbestand #}
    <input type="number" id="artikel_mindestbestand" name="mindestbestand" min="0" value="0" required><br><br>
    <button type="submit">Artikel hinzufügen</button>
</form>

---

{# -- GUTHABEN AUFLADEN (JavaScript-Teil und Modal hier belassen, da er nur für Admin-Seite relevant ist) -- #}
<h2>Guthaben aufladen</h2>
<form id="memberSearchFormAufladen">
    <input type="text" id="search_term_aufladen" placeholder="Mitglied suchen...">
    <button type="button" id="searchButtonAufladen">Suchen</button>
    <button type="button" id="resetSearchButtonAufladen" style="display:none;">Alle anzeigen</button>
</form>
<div id="memberListAufladen" class="member-grid">
    {# Hier werden Mitglieder dynamisch geladen oder initial von Flask übergeben #}
    {% if alle_mitglieder_for_recharge %} {# Annahme: Flask übergibt hier die Mitglieder für die Aufladefunktion #}
        <script>
            // Dies rendert die Mitglieder initial, wenn sie von Flask übergeben werden
            document.addEventListener('DOMContentLoaded', () => {
                renderMembersForRecharge({{ alle_mitglieder_for_recharge | tojson | safe }});
            });
        </script>
    {% endif %}
</div>

<div id="rechargeModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Guthaben aufladen für: <span id="rechargeMemberName"></span></h2>
        <p>Aktueller Kontostand: <span id="rechargeMemberBalance"></span> €</p>
        <form id="rechargeForm">
            <label for="amount">Betrag (€):</label>
            <input type="number" id="amount" step="0.01" min="0.01" required>
            <button type="submit">Aufladen</button>
        </form>
    </div>
</div>
---

{# -- MITGLIEDER VERWALTEN -- #}
<h2>Mitglieder verwalten</h2>
{% if alle_mitglieder %}
<div class="table-responsive mb-4">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Name</th>
                <th>PIN</th>
                <th>Guthaben</th>
                <th>Aktionen</th>
            </tr>
        </thead>
        <tbody>
            {% for mitglied in alle_mitglieder %}
            <tr>
                <td>{{ mitglied.name }}</td>
                <td>{{ mitglied.pin }}</td>
                <td>{{ "%.2f"|format(mitglied.guthaben) }}€</td>
                <td>
                    <a href="{{ url_for('admin.mitglied_bearbeiten', mitglied_id=mitglied.id) }}" class="button small">Bearbeiten</a>
                    <form action="{{ url_for('admin.mitglied_loeschen', mitglied_id=mitglied.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Sicher, dass du {{ mitglied.name }} löschen möchtest? Alle Transaktionen dieses Mitglieds werden ebenfalls gelöscht!');">
    <button type="submit" class="button small delete-button">Löschen</button>
</form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<p class="alert alert-info">Keine Mitglieder vorhanden.</p>
{% endif %}

---

{# -- ARTIKEL VERWALTEN -- #}
<h2>Artikel verwalten</h2>
{% if alle_artikel %}
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Name</th>
                <th>Preis</th>
                <th>Bestand</th>
                <th>Mindestbestand</th>
                <th>Aktionen</th>
            </tr>
        </thead>
        <tbody>
            {% for artikel_item in alle_artikel %}
            <tr class="{% if artikel_item.bestand < artikel_item.mindestbestand %}bestand-niedrig{% endif %}">
                <td>{{ artikel_item.name }}</td>
                <td>{{ "%.2f"|format(artikel_item.preis) }}€</td>
                <td>{{ artikel_item.bestand }}</td> {# Dies zeigt den aktuellen Bestand an #}
                <td>
                    {# FORMULAR FÜR MINDESTBESTAND #}
                    <form action="{{ url_for('admin.mindestbestand_setzen', artikel_id=artikel_item.id) }}" method="post" class="d-inline-flex align-items-center">
                        <input type="hidden" name="artikel_id" value="{{ artikel_item.id }}">
                        <input type="number" name="neuer_mindestbestand" value="{{ artikel_item.mindestbestand }}" min="0" class="form-control form-control-sm mr-2" style="width: 70px;">
                        <button type="submit" class="btn btn-info btn-sm">Speichern</button>
                    </form>
                </td>
                <td>
                    {# NEUES FORMULAR HINZUFÜGEN: FÜR DEN AKTUELLEN BESTAND (STAND) #}
                    <form action="{{ url_for('admin.bestand_auf_setzen', artikel_id=artikel_item.id) }}" method="post" class="d-inline-flex align-items-center">
                        <input type="number" name="neuer_bestand" value="{{ artikel_item.bestand }}" min="0" class="form-control form-control-sm mr-2" style="width: 70px;">
                        <button type="submit" class="btn btn-primary btn-sm">Stand setzen</button> {# Button-Farbe geändert, um sie zu unterscheiden #}
                    </form>
                </td>
                <td>
                    {# AKTIONEN (Bearbeiten/Löschen) - Bleibt unverändert #}
                    <a href="{{ url_for('admin.artikel_bearbeiten', artikel_id=artikel_item.id) }}" class="btn btn-primary btn-sm">Bearbeiten</a>
                    <form action="{{ url_for('admin.artikel_loeschen', artikel_id=artikel_item.id) }}" method="post" class="d-inline-flex">
                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Sicher?');">Löschen</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<p class="alert alert-info">Keine Artikel vorhanden.</p>
{% endif %}
{% endblock %}

{% block scripts %}
{# JAVASCRIPT FÜR GUTHABEN AUFLADEN #}
<script>
    // --- Globale Variablen für das Aufladen-Modal ---
    let selectedMemberIdRecharge = null;
    let selectedMemberNameRecharge = '';
    let selectedMemberBalanceRecharge = 0;

    // --- DOM-Elemente für die Aufladen-Seite ---
    // Prüfen, ob die Elemente existieren, bevor darauf zugegriffen wird
    const memberSearchFormAufladen = document.getElementById('memberSearchFormAufladen');
    const searchTermInputAufladen = document.getElementById('search_term_aufladen');
    const searchButtonAufladen = document.getElementById('searchButtonAufladen');
    const resetSearchButtonAufladen = document.getElementById('resetSearchButtonAufladen');
    const memberListAufladenContainer = document.getElementById('memberListAufladen');

    const rechargeModal = document.getElementById('rechargeModal');
    const closeRechargeButton = rechargeModal ? rechargeModal.querySelector('.close-button') : null;
    const rechargeMemberNameSpan = document.getElementById('rechargeMemberName');
    const rechargeMemberBalanceSpan = document.getElementById('rechargeMemberBalance');
    const rechargeForm = document.getElementById('rechargeForm');
    const amountInput = document.getElementById('amount');


    // --- Funktionen für die Aufladen-Seite ---

    // Funktion zum Rendern der Mitglieder für die Aufladen-Seite
    function renderMembersForRecharge(members) {
        if (!memberListAufladenContainer) return; // Schutz, falls Element nicht existiert
        memberListAufladenContainer.innerHTML = ''; // Vorherige Liste leeren
        if (members.length === 0) {
            memberListAufladenContainer.innerHTML = '<p>Keine Mitglieder gefunden.</p>';
            return;
        }

        members.forEach(mitglied => {
            const memberItem = document.createElement('div');
            memberItem.classList.add('member-item'); // Wiederverwenden der CSS-Klasse
            memberItem.dataset.id = mitglied.id;
            memberItem.dataset.name = mitglied.name;
            memberItem.dataset.balance = mitglied.guthaben;

            memberItem.innerHTML = `
                <h3>${mitglied.name}</h3>
                <p>Kontostand: ${mitglied.guthaben.toFixed(2)} €</p>
            `;
            memberListAufladenContainer.appendChild(memberItem);

            // Event Listener für den Klick auf ein Mitglied
            memberItem.addEventListener('click', function() {
                selectedMemberIdRecharge = this.dataset.id;
                selectedMemberNameRecharge = this.dataset.name;
                selectedMemberBalanceRecharge = parseFloat(this.dataset.balance);

                if (rechargeMemberNameSpan) rechargeMemberNameSpan.textContent = selectedMemberNameRecharge;
                if (rechargeMemberBalanceSpan) rechargeMemberBalanceSpan.textContent = selectedMemberBalanceRecharge.toFixed(2);
                if (amountInput) amountInput.value = ''; // Betragsfeld leeren

                if (rechargeModal) rechargeModal.classList.add =('is-visible'); // Modal anzeigen
            });
        });
    }

    // Funktion, um Mitglieder vom Server abzurufen
    async function fetchMembersForRecharge(searchTerm = '') {
        const url = searchTerm ? `/api/members?search=${searchTerm}` : '/api/members';
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (data.success) {
                renderMembersForRecharge(data.members);
                if (searchTerm && resetSearchButtonAufladen) {
                    resetSearchButtonAufladen.style.display = 'inline-block'; // "Alle anzeigen" Button zeigen
                } else if (resetSearchButtonAufladen) {
                    resetSearchButtonAufladen.style.display = 'none'; // "Alle anzeigen" Button verstecken
                }
            } else {
                alert('Fehler beim Laden der Mitglieder: ' + data.message);
            }
        } catch (error) {
            console.error('Fehler beim Abrufen der Mitglieder:', error);
            alert('Ein Fehler ist beim Laden der Mitglieder aufgetreten.');
        }
    }


    // --- Event Listener für die Aufladen-Seite ---

    // Initiales Laden aller Mitglieder beim Seitenstart
    // Diese Zeile ist auskommentiert, da du sie in app.py mit render_template direkt übergibst.
    // Wenn du AJAX hier verwenden möchtest, musst du diese Codezeile aktivieren und die `mitglieder`-Übergabe im Flask-Route entfernen.
    // const initialMembersDataRecharge = {{ alle_mitglieder_for_recharge | tojson | safe }};
    // console.log("Initial geladene Mitgliederdaten (Aufladen):", initialMembersDataRecharge);
    // renderMembersForRecharge(initialMembersDataRecharge);
    // eventuell wichtig

    // Event Listener nur hinzufügen, wenn die Elemente existieren
    if (searchButtonAufladen) {
        searchButtonAufladen.addEventListener('click', function(event) {
            event.preventDefault(); // Standard-Submit verhindern
            const searchTerm = searchTermInputAufladen.value.trim();
            fetchMembersForRecharge(searchTerm);
        });
    }

    if (searchTermInputAufladen) {
        searchTermInputAufladen.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Standard-Submit verhindern
                if (searchButtonAufladen) searchButtonAufladen.click(); // Such-Button klicken
            }
        });
    }

    if (resetSearchButtonAufladen) {
        resetSearchButtonAufladen.addEventListener('click', function() {
            if (searchTermInputAufladen) searchTermInputAufladen.value = ''; // Suchfeld leeren
            fetchMembersForRecharge(''); // Alle Mitglieder laden
        });
    }

    if (rechargeForm) {
        rechargeForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const amount = parseFloat(amountInput.value);

            if (isNaN(amount) || amount <= 0) {
                alert('Bitte einen gültigen Betrag eingeben.');
                return;
            }

            try {
                const response = await fetch('/mitglied/guthaben_aufladen', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mitglied_id: selectedMemberIdRecharge,
                        amount: amount
                    })
                });
                const data = await response.json();

                if (data.success) {
                    alert(`Guthaben erfolgreich aufgeladen! Neuer Kontostand: ${data.new_balance.toFixed(2)} €`);
                    if (rechargeModal) rechargeModal.style.display = 'none'; // Modal schließen
                    // Aktualisiere den Kontostand im UI
                    const memberItemToUpdate = document.querySelector(`#memberListAufladen .member-item[data-id="${selectedMemberIdRecharge}"]`);
                    if (memberItemToUpdate) {
                        memberItemToUpdate.querySelector('p').textContent = `Kontostand: ${data.new_balance.toFixed(2)} €`;
                        memberItemToUpdate.dataset.balance = data.new_balance;
                    }
                    // Optional: Mitgliederliste neu laden, um die aktualisierten Daten anzuzeigen
                    // fetchMembersForRecharge(searchTermInputAufladen.value.trim());
                } else {
                    alert('Fehler beim Aufladen: ' + data.message);
                }
            } catch (error) {
                console.error('Fehler beim Aufladen:', error);
                alert('Ein Fehler ist beim Aufladen aufgetreten.');
            }
        });
    }

    if (closeRechargeButton) {
        closeRechargeButton.addEventListener('click', function() {
            if (rechargeModal) rechargeModal.classList.remove('is-visible');
        });
    }

    if (rechargeModal) {
        window.addEventListener('click', function(event) {
            if (event.target == rechargeModal) {
                rechargeModal.classList.remove('is-visible');
            }
        });
    }
</script>
{% endblock %}